#include <stdio.h>

#include "enigma.h"

#define ROTOR_SIZE 256
#define ROTOR_NUM 3

int main(int argc, char **argv) {
    if (argc < 2) {
        perror("no input file");
        return -1;
    }

    enigma_t *enigma = new_enigma(ROTOR_NUM, ROTOR_SIZE);
    if (enigma == NULL) {
        perror("enigma creation failed");
        return -1;
    }

    unsigned int commutator[ROTOR_SIZE];
    for (int i = 0; i < ROTOR_SIZE; ++i) commutator[i] = ROTOR_SIZE - i - 1;
    unsigned int reflector[ROTOR_SIZE];
    for (int i = 0; i < ROTOR_SIZE; ++i) reflector[i] = ROTOR_SIZE - i - 1;
    unsigned int *rotors[] = {
            (unsigned int[]) {159, 37, 53, 237, 156, 39, 141, 151, 106, 179, 78, 70, 82, 178, 192, 116, 64, 148, 131,
                              174, 221, 231, 125,
                              119, 20, 135, 41, 168, 47, 69, 107, 228, 18, 130, 32, 36, 244, 177, 136, 242, 76, 71, 124,
                              129, 24, 207,
                              199, 201, 44, 55, 162, 158, 191, 194, 139, 109, 72, 164, 67, 13, 230, 213, 216, 87, 102,
                              92, 77, 1, 138,
                              184, 110, 0, 114, 31, 189, 118, 133, 181, 245, 68, 211, 25, 15, 74, 88, 85, 134, 48, 247,
                              240, 229, 208, 9,
                              113, 155, 161, 157, 143, 8, 58, 140, 232, 34, 120, 2, 111, 202, 146, 248, 142, 65, 89, 7,
                              254, 28, 46, 54,
                              121, 236, 95, 126, 150, 197, 4, 153, 50, 132, 97, 91, 21, 42, 43, 220, 117, 122, 234, 27,
                              10, 171, 217,
                              222, 22, 75, 187, 79, 214, 112, 183, 147, 193, 12, 94, 163, 40, 246, 19, 26, 86, 251, 123,
                              56, 52, 11, 137,
                              3, 255, 160, 61, 66, 96, 99, 23, 210, 101, 196, 226, 182, 188, 170, 145, 5, 165, 62, 100,
                              175, 167, 115,
                              57, 63, 83, 224, 195, 204, 108, 98, 225, 172, 238, 186, 218, 49, 166, 29, 73, 206, 104,
                              215, 169, 90, 243,
                              239, 59, 198, 253, 33, 249, 180, 51, 176, 16, 35, 209, 6, 30, 233, 205, 252, 17, 219, 173,
                              203, 38, 128,
                              81, 154, 80, 227, 127, 93, 241, 212, 152, 60, 223, 149, 250, 45, 185, 200, 144, 14, 105,
                              190, 235, 84,
                              103},
            (unsigned int[]) {114, 228, 70, 173, 201, 178, 195, 77, 9, 29, 108, 194, 45, 242, 55, 169, 87, 171, 221,
                              103, 43, 30, 205,
                              100, 131, 121, 160, 7, 156, 214, 136, 177, 20, 226, 24, 163, 137, 219, 146, 170, 81, 56,
                              190, 243, 18, 116,
                              61, 26, 32, 204, 2, 122, 141, 110, 157, 206, 159, 90, 73, 39, 58, 176, 211, 102, 48, 106,
                              94, 31, 148, 33,
                              98, 72, 123, 37, 74, 144, 25, 155, 248, 17, 180, 117, 207, 83, 186, 85, 158, 34, 115, 254,
                              237, 164, 202,
                              240, 165, 222, 217, 128, 92, 203, 161, 143, 44, 172, 11, 93, 179, 27, 250, 215, 8, 113,
                              66, 212, 4, 167,
                              96, 234, 79, 140, 210, 154, 105, 47, 224, 104, 239, 232, 57, 223, 252, 209, 241, 135, 251,
                              150, 112, 193,
                              147, 86, 52, 225, 249, 91, 227, 184, 168, 119, 23, 78, 246, 181, 244, 233, 82, 255, 166,
                              51, 197, 28, 0, 6,
                              53, 149, 229, 174, 71, 218, 151, 139, 230, 183, 132, 97, 120, 42, 235, 16, 60, 69, 13, 19,
                              80, 95, 130,
                              199, 185, 208, 64, 189, 40, 22, 109, 245, 65, 125, 126, 111, 247, 213, 192, 41, 145, 1,
                              142, 162, 75, 54,
                              3, 21, 220, 5, 88, 182, 175, 118, 59, 134, 253, 63, 152, 129, 191, 38, 76, 50, 124, 138,
                              188, 127, 67, 107,
                              187, 133, 12, 216, 68, 101, 89, 35, 84, 36, 99, 231, 10, 200, 15, 46, 14, 236, 49, 238,
                              153, 62, 198, 196},
            (unsigned int[]) {123, 177, 194, 127, 26, 242, 22, 94, 202, 145, 245, 110, 15, 170, 204, 54, 102, 147, 43,
                              196, 209, 38, 50,
                              95, 221, 234, 71, 66, 201, 184, 146, 219, 131, 42, 18, 244, 149, 188, 27, 60, 133, 0, 153,
                              21, 20, 169,
                              218, 166, 24, 109, 11, 251, 195, 98, 217, 142, 114, 3, 1, 178, 203, 253, 180, 48, 34, 9,
                              181, 37, 171, 175,
                              65, 159, 28, 228, 83, 236, 117, 165, 250, 138, 59, 135, 116, 189, 247, 85, 122, 44, 185,
                              212, 173, 90, 179,
                              254, 19, 52, 86, 187, 106, 67, 222, 128, 32, 126, 53, 89, 29, 112, 200, 75, 92, 240, 151,
                              84, 47, 199, 139,
                              150, 227, 161, 132, 12, 238, 156, 40, 162, 220, 143, 208, 231, 124, 129, 35, 121, 197,
                              154, 168, 78, 23,
                              51, 6, 125, 118, 57, 68, 33, 7, 100, 183, 108, 82, 155, 137, 76, 45, 174, 41, 134, 105, 4,
                              72, 191, 70, 10,
                              237, 103, 56, 213, 77, 157, 58, 119, 239, 232, 172, 252, 62, 63, 99, 214, 39, 255, 216,
                              140, 226, 61, 46,
                              164, 87, 74, 233, 225, 206, 248, 8, 205, 210, 93, 115, 176, 55, 160, 69, 31, 215, 2, 249,
                              96, 229, 223,
                              241, 13, 186, 235, 130, 144, 5, 158, 182, 64, 36, 243, 141, 107, 81, 104, 190, 148, 16,
                              101, 73, 136, 91,
                              25, 246, 211, 17, 97, 113, 152, 198, 163, 230, 30, 193, 14, 207, 167, 49, 79, 192, 111,
                              224, 80, 88, 120}
    };

    set_commutator(enigma, commutator);
    set_rotors(enigma, rotors);
    set_reflector(enigma, reflector);

    FILE *input = fopen(argv[1], "r");
    if (input == NULL) {
        perror("error while opening input file");
        free_enigma(enigma);
        return -1;
    }

    FILE *output = fopen(argc < 3 ? "out.txt" : argv[2], "w");
    if (output == NULL) {
        perror("error while opening output file");
        free_enigma(enigma);
        return -1;
    }

    unsigned int symbol = 0, new_symbol = 0;
    int status = 0;
    while ((symbol = fgetc(input)) != EOF) {
//        printf("%d ", symbol);
        new_symbol = encrypt(enigma, symbol, &status);
        if (status == 0) {
            fclose(input);
            fclose(output);
            remove(argv[2]);
            free_enigma(enigma);
            return -1;
        }
//        printf("%d\n", new_symbol);
        fputc(new_symbol, output);
    }

    fclose(input);
    fclose(output);

    free_enigma(enigma);

    return 0;
}